---
import CommandLine from '../../components/CommandLine.astro';
import Layout from '../../layouts/Layout.astro';
import headline from '../../utils/headline';
import { MODULE_GUIDES, MODULE_LIST, buildFaq } from '../../utils/moduleCatalog';
const { module } = Astro.params;
const moduleKey = typeof module === 'string' ? module : '';
const isKnownModule = MODULE_LIST.includes(moduleKey);
const guide = isKnownModule ? MODULE_GUIDES[moduleKey] : undefined;
const meta = isKnownModule && headline[moduleKey] ? headline[moduleKey] : undefined;
const title = meta?.title ?? 'Fakeact';
const description = meta?.desc ?? 'Fakeact module';
const commandExamples = isKnownModule ? [
    `fakeact -m ${moduleKey}`,
    `fakeact -m ${moduleKey} -s 1.5 -t 1`,
    `docker run -it --rm ch563/fakeact -m ${moduleKey}`,
] : [];
const relatedModules = MODULE_LIST.filter((name) => name !== moduleKey);
const faqItems = isKnownModule ? buildFaq(moduleKey) : [];
const introParagraphs = guide ? [
    `This module simulates ${guide.tags[0]}, ${guide.tags[1]}, and ${guide.tags[2]} log events with realistic pacing.`,
    'It is designed for demos, log pipeline testing, and documentation where the real stack is unavailable.',
    'All output is generated locally in the browser and is safe to run.',
] : [];
---

<Layout title={title} description={description}>
    <div class="bg-black text-white">
        <div class="container mx-auto max-w-6xl px-4 py-8">
            <div class="flex items-center justify-between text-xs text-gray-500">
                <a class="hover:text-gray-300" href="/">Back to home</a>
                {isKnownModule ? <span>Module: {moduleKey}</span> : <span>Unknown module</span>}
            </div>
            <h1 class="mt-4 text-2xl font-semibold text-gray-100">{title}</h1>
            <p class="mt-2 text-sm text-gray-400">{description}</p>

            {guide ? (
                <>
                    <div class="mt-8 grid gap-6 lg:grid-cols-3">
                        <div class="lg:col-span-2">
                            <div id="command-shell-wrapper" class="command-shell-wrapper rounded-md border border-gray-800 bg-black/60">
                                <div class="command-shell-top-zone" data-commandline-top-zone aria-hidden="true"></div>
                                <div class="command-shell-toolbar flex items-center justify-between gap-3 border-b border-gray-800/70 px-3 py-2 text-xs uppercase tracking-wide text-gray-400">
                                    <span>Terminal preview</span>
                                    <button
                                        type="button"
                                        class="flex items-center gap-2 rounded border border-gray-700/60 px-3 py-1.5 text-[11px] font-semibold text-gray-200 transition hover:border-gray-500 hover:text-white"
                                        data-commandline-fullscreen
                                        aria-pressed="false"
                                        aria-controls="command-shell-wrapper"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-3.5 w-3.5">
                                            <path d="M4.5 3A1.5 1.5 0 0 0 3 4.5V7a1 1 0 0 0 2 0V5h2a1 1 0 1 0 0-2zm9 0a1 1 0 1 0 0 2h2v2a1 1 0 1 0 2 0V4.5A1.5 1.5 0 0 0 16.5 3zm-9 14a1 1 0 1 0 0-2H4v-2a1 1 0 1 0-2 0v2.5A1.5 1.5 0 0 0 3.5 17zm9 0H15v-2a1 1 0 1 0 2 0v2.5a1.5 1.5 0 0 1-1.5 1.5H13a1 1 0 1 1 0-2" />
                                        </svg>
                                        <span data-commandline-fullscreen-label>全屏模式</span>
                                    </button>
                                </div>
                                <div class="command-shell-terminal h-[60vh] min-h-[420px] p-2">
                                    <CommandLine module={moduleKey} />
                                </div>
                            </div>
                            <p class="mt-2 text-xs text-gray-500">
                                Press Ctrl + C to exit. Output is simulated for demo purposes only.
                            </p>
                        </div>
                        <aside class="space-y-6">
                            <div>
                                <h2 class="text-xs font-semibold uppercase tracking-wide text-gray-400">
                                    Highlights
                                </h2>
                                <ul class="mt-3 list-disc list-inside text-sm text-gray-300 space-y-1">
                                    {guide.highlights.map((item) => (
                                        <li>{item}</li>
                                    ))}
                                </ul>
                            </div>
                            <div>
                                <h2 class="text-xs font-semibold uppercase tracking-wide text-gray-400">
                                    Tags
                                </h2>
                                <div class="mt-3 flex flex-wrap gap-2">
                                    {guide.tags.map((tag) => (
                                        <span class="rounded-full border border-gray-700 px-2 py-1 text-xs text-gray-300">
                                            {tag}
                                        </span>
                                    ))}
                                </div>
                            </div>
                            <div>
                                <h2 class="text-xs font-semibold uppercase tracking-wide text-gray-400">
                                    Quick commands
                                </h2>
                                <div class="mt-3 space-y-2 text-xs text-gray-300">
                                    {commandExamples.map((cmd) => (
                                        <div class="rounded border border-gray-800 bg-gray-950 px-3 py-2 font-mono">
                                            {cmd}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </aside>
                    </div>

                    <div class="mt-10 grid gap-8 lg:grid-cols-2">
                        <div class="space-y-3 text-sm text-gray-300">
                            <h2 class="text-lg font-semibold text-gray-200">Overview</h2>
                            {introParagraphs.map((paragraph) => (
                                <p>{paragraph}</p>
                            ))}
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold text-gray-200">Use cases</h2>
                            <ul class="mt-3 list-disc list-inside text-sm text-gray-300 space-y-1">
                                {guide.scenarios.map((item) => (
                                    <li>{item}</li>
                                ))}
                            </ul>
                            <h3 class="mt-6 text-sm font-semibold text-gray-300">Notes</h3>
                            <ul class="mt-2 list-disc list-inside text-sm text-gray-400 space-y-1">
                                <li>All output is simulated text; no system changes are made.</li>
                                <li>Refresh the page to restart the log stream.</li>
                                <li>Use the CLI for longer sessions or offline demos.</li>
                            </ul>
                        </div>
                    </div>

                    <section class="mt-10">
                        <h2 class="text-lg font-semibold text-gray-200">Sample output</h2>
                        <pre class="mt-3 overflow-auto rounded-md border border-gray-800 bg-gray-950 p-4 text-xs text-gray-300">{guide.sampleOutput.join('\n')}</pre>
                    </section>

                    <section class="mt-10">
                        <h2 class="text-lg font-semibold text-gray-200">FAQ</h2>
                        <div class="mt-4 grid gap-4 lg:grid-cols-2">
                            {faqItems.map((item) => (
                                <div class="rounded-md border border-gray-800 bg-black/50 p-4">
                                    <div class="text-sm font-semibold text-gray-200">{item.question}</div>
                                    <p class="mt-2 text-sm text-gray-400">{item.answer}</p>
                                </div>
                            ))}
                        </div>
                    </section>

                    <section class="mt-10">
                        <h2 class="text-lg font-semibold text-gray-200">Related modules</h2>
                        <div class="mt-3 grid grid-cols-2 gap-2 sm:grid-cols-3 lg:grid-cols-4">
                            {relatedModules.map((name) => (
                                <a
                                    class="rounded border border-gray-800 bg-gray-950 px-3 py-2 text-xs text-gray-300 hover:border-gray-700 hover:text-white"
                                    href={`/module/${name}`}
                                >
                                    {name}
                                </a>
                            ))}
                        </div>
                    </section>
                </>
            ) : (
                <div class="mt-8 rounded-md border border-red-900/40 bg-red-950/30 p-4 text-sm text-red-200">
                    This module is not available. Please choose a module from the home page.
                </div>
            )}
        </div>
    </div>
</Layout>

<script is:inline>
    const initCommandLineFullscreen = () => {
        const wrapper = document.getElementById('command-shell-wrapper');
        const toggleButton = document.querySelector('[data-commandline-fullscreen]');
        const toolbar = wrapper?.querySelector('.command-shell-toolbar');
        const topZone = wrapper?.querySelector('[data-commandline-top-zone]');
        if (!wrapper || !toggleButton || !toolbar) {
            return;
        }

        const onPointerReveal = () => {
            if (!isFullscreen) return;
            revealToolbar();
        };

        const label = toggleButton.querySelector('[data-commandline-fullscreen-label]');
        const html = document.documentElement;
        const body = document.body;
        let isFullscreen = false;
        let hideTimer = -1;

        const setToolbarHidden = (hidden) => {
            toolbar.classList.toggle('is-hidden', hidden);
        };

        const clearHideTimer = () => {
            if (hideTimer !== -1) {
                window.clearTimeout(hideTimer);
                hideTimer = -1;
            }
        };

        const scheduleToolbarHide = () => {
            clearHideTimer();
            if (!isFullscreen) {
                return;
            }
            hideTimer = window.setTimeout(() => {
                setToolbarHidden(true);
            }, 2000);
        };

        const revealToolbar = () => {
            setToolbarHidden(false);
            scheduleToolbarHide();
        };

        const applyState = () => {
            wrapper.classList.toggle('is-fullscreen', isFullscreen);
            html.classList.toggle('command-fullscreen-open', isFullscreen);
            body.classList.toggle('command-fullscreen-open', isFullscreen);
            toggleButton.setAttribute('aria-pressed', String(isFullscreen));
            if (label) {
                label.textContent = isFullscreen ? '退出全屏' : '全屏模式';
            }
            if (isFullscreen) {
                revealToolbar();
            } else {
                clearHideTimer();
                setToolbarHidden(false);
            }
            window.dispatchEvent(new Event('resize'));
        };

        const toggleFullscreen = () => {
            isFullscreen = !isFullscreen;
            applyState();
        };

        toggleButton.addEventListener('click', toggleFullscreen);
        toggleButton.addEventListener('focus', onPointerReveal);
        wrapper.addEventListener('pointermove', onPointerReveal);
        if (topZone) {
            topZone.addEventListener('pointerenter', onPointerReveal);
            topZone.addEventListener('pointermove', onPointerReveal);
        }
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && isFullscreen) {
                isFullscreen = false;
                applyState();
            }
        });
    };

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCommandLineFullscreen, { once: true });
    } else {
        initCommandLineFullscreen();
    }
</script>

<style is:global>
    .command-shell-wrapper {
        position: relative;
    }

    .command-shell-toolbar {
        transition: opacity 0.4s ease, transform 0.4s ease;
    }

    .command-shell-toolbar.is-hidden {
        opacity: 0;
        transform: translateY(-100%);
        pointer-events: none;
    }

    .command-shell-top-zone {
        display: none;
    }

    .command-shell-wrapper.is-fullscreen .command-shell-top-zone {
        display: block;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 72px;
        z-index: 10;
        cursor: default;
    }

    .command-shell-wrapper.is-fullscreen {
        position: fixed;
        inset: 0;
        z-index: 40;
        max-width: none;
        width: 100%;
        height: 100vh;
        border-radius: 0;
        border: none;
        padding: 1rem;
        background-color: #050505;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        overflow: visible;
    }

    .command-shell-wrapper.is-fullscreen .command-shell-toolbar {
        position: absolute;
        top: 1rem;
        left: 1rem;
        right: 1rem;
        z-index: 11;
        background: rgba(12, 12, 12, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 0.5rem;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(8px);
    }

    .command-shell-wrapper.is-fullscreen .command-shell-terminal {
        flex: 1;
        height: auto;
        min-height: 0;
    }

    .command-shell-terminal {
        transition: height 0.2s ease;
    }

    html.command-fullscreen-open,
    body.command-fullscreen-open {
        overflow: hidden;
    }
</style>
