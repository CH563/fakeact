---
import CommandLine from '../../components/CommandLine.astro';
import Layout from '../../layouts/Layout.astro';
import headline from '../../utils/headline';
import Footer from '../../components/footer.astro';
import { MODULE_GUIDES, MODULE_LIST, buildFaq } from '../../utils/moduleCatalog';
import { getModuleMoreAbout, getModuleDisplayName, getModuleStackOverflowQuestions, getModuleYouTubeVideos } from '../../utils/moduleMoreAbout';

const { module } = Astro.params;
const { origin } = Astro.url;
const moduleKey = typeof module === 'string' ? module : '';
const isKnownModule = MODULE_LIST.includes(moduleKey);
const guide = isKnownModule ? MODULE_GUIDES[moduleKey] : undefined;
const meta = isKnownModule && headline[moduleKey] ? headline[moduleKey] : undefined;
const title = meta?.title ?? 'Fakeact';
const description = meta?.desc ?? 'Fakeact module';
const keywords = meta?.keywords ?? '';
const shortName = meta?.shortName ?? moduleKey;
const category = meta?.category ?? 'Developer Tools';
const commandExamples = isKnownModule ? [
    `fakeact -m ${moduleKey}`,
    `fakeact -m ${moduleKey} -s 1.5 -t 1`,
    `docker run -it --rm ch563/fakeact -m ${moduleKey}`,
] : [];
const relatedModules = MODULE_LIST.filter((name) => name !== moduleKey);
const faqItems = isKnownModule ? buildFaq(moduleKey) : [];
const moreAbout = isKnownModule ? getModuleMoreAbout(moduleKey) : undefined;
const moduleDisplayName = getModuleDisplayName(moduleKey);
const stackOverflowQuestions = isKnownModule ? getModuleStackOverflowQuestions(moduleKey) : [];
const youtubeVideos = isKnownModule ? getModuleYouTubeVideos(moduleKey) : [];
const introParagraphs = guide ? [
    `This module simulates ${guide.tags[0]}, ${guide.tags[1]}, and ${guide.tags[2]} log events with realistic pacing.`,
    'It is designed for demos, log pipeline testing, and documentation where the real stack is unavailable.',
    'All output is generated locally in the browser and is safe to run.',
] : [];

// JSON-LD Structured Data
const pageUrl = `${origin}/module/${moduleKey}`;
const jsonLd = isKnownModule ? {
    '@context': 'https://schema.org',
    '@graph': [
        // WebApplication Schema
        {
            '@type': 'WebApplication',
            '@id': `${pageUrl}#webapp`,
            'name': shortName,
            'description': description,
            'url': pageUrl,
            'applicationCategory': category,
            'operatingSystem': 'Any',
            'browserRequirements': 'Requires JavaScript',
            'offers': {
                '@type': 'Offer',
                'price': '0',
                'priceCurrency': 'USD',
            },
            'creator': {
                '@type': 'Organization',
                'name': 'Fakeact',
                'url': origin,
            },
            'featureList': guide?.highlights ?? [],
            'keywords': keywords,
        },
        // FAQPage Schema
        {
            '@type': 'FAQPage',
            '@id': `${pageUrl}#faq`,
            'mainEntity': [
                ...faqItems.map(item => ({
                    '@type': 'Question',
                    'name': item.question,
                    'acceptedAnswer': {
                        '@type': 'Answer',
                        'text': item.answer,
                    },
                })),
                ...stackOverflowQuestions.slice(0, 5).map(item => ({
                    '@type': 'Question',
                    'name': item.question,
                    'acceptedAnswer': {
                        '@type': 'Answer',
                        'text': item.answer,
                    },
                })),
            ],
        },
        // HowTo Schema for using the tool
        {
            '@type': 'HowTo',
            '@id': `${pageUrl}#howto`,
            'name': `How to use ${shortName}`,
            'description': `Generate realistic ${moduleDisplayName} logs with Fakeact`,
            'step': [
                {
                    '@type': 'HowToStep',
                    'position': 1,
                    'name': 'Open the simulator',
                    'text': `Navigate to the ${shortName} page on Fakeact`,
                },
                {
                    '@type': 'HowToStep',
                    'position': 2,
                    'name': 'View the terminal',
                    'text': 'The simulated log output will start automatically in the terminal preview',
                },
                {
                    '@type': 'HowToStep',
                    'position': 3,
                    'name': 'Use CLI for advanced options',
                    'text': `Run "fakeact -m ${moduleKey}" for command-line usage with speed and repeat options`,
                },
            ],
            'tool': {
                '@type': 'HowToTool',
                'name': 'Web Browser or Terminal',
            },
        },
        // BreadcrumbList Schema
        {
            '@type': 'BreadcrumbList',
            '@id': `${pageUrl}#breadcrumb`,
            'itemListElement': [
                {
                    '@type': 'ListItem',
                    'position': 1,
                    'name': 'Home',
                    'item': origin,
                },
                {
                    '@type': 'ListItem',
                    'position': 2,
                    'name': shortName,
                    'item': pageUrl,
                },
            ],
        },
        // SoftwareSourceCode for CLI examples
        {
            '@type': 'SoftwareSourceCode',
            '@id': `${pageUrl}#code`,
            'name': `${shortName} CLI Commands`,
            'programmingLanguage': 'Bash',
            'codeRepository': 'https://github.com/nicehash/fakeact',
            'codeSampleType': 'full',
            'text': commandExamples.join('\n'),
        },
        // VideoObject Schema for YouTube tutorials
        ...youtubeVideos.map((video, index) => ({
            '@type': 'VideoObject',
            '@id': `${pageUrl}#video${index + 1}`,
            'name': video.title,
            'description': video.description,
            'thumbnailUrl': `https://img.youtube.com/vi/${video.videoId}/maxresdefault.jpg`,
            'uploadDate': '2024-01-01',
            'contentUrl': `https://www.youtube.com/watch?v=${video.videoId}`,
            'embedUrl': `https://www.youtube.com/embed/${video.videoId}`,
            'publisher': {
                '@type': 'Organization',
                'name': video.channel,
                'logo': {
                    '@type': 'ImageObject',
                    'url': 'https://www.youtube.com/favicon.ico',
                },
            },
        })),
    ],
} : undefined;
---

<Layout title={title} description={description} keywords={keywords} jsonLd={jsonLd}>
    <div class="bg-black text-white">
        <div class="container mx-auto max-w-6xl px-4 py-8">
            <div class="flex items-center justify-between text-xs text-gray-500">
                <a class="hover:text-gray-300" href="/">Back to home</a>
                {isKnownModule ? <span>Module: {moduleKey}</span> : <span>Unknown module</span>}
            </div>
            <h1 class="mt-4 text-2xl font-semibold text-gray-100">{title}</h1>
            <p class="mt-2 text-sm text-gray-400">{description}</p>

            {guide ? (
                <>
                    <div class="mt-8 grid gap-6 lg:grid-cols-3">
                        <div class="lg:col-span-2">
                            <div id="command-shell-wrapper" class="command-shell-wrapper rounded-md border border-gray-800 bg-black/60">
                                <div class="command-shell-top-zone" data-commandline-top-zone aria-hidden="true"></div>
                                <div class="command-shell-toolbar flex items-center justify-between gap-3 border-b border-gray-800/70 px-3 py-2 text-xs uppercase tracking-wide text-gray-400">
                                    <span>Terminal preview</span>
                                    <button
                                        type="button"
                                        class="flex items-center gap-2 rounded border border-gray-700/60 px-3 py-1.5 text-[11px] font-semibold text-gray-200 transition hover:border-gray-500 hover:text-white"
                                        data-commandline-fullscreen
                                        aria-pressed="false"
                                        aria-controls="command-shell-wrapper"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-3.5 w-3.5">
                                            <path d="M4.5 3A1.5 1.5 0 0 0 3 4.5V7a1 1 0 0 0 2 0V5h2a1 1 0 1 0 0-2zm9 0a1 1 0 1 0 0 2h2v2a1 1 0 1 0 2 0V4.5A1.5 1.5 0 0 0 16.5 3zm-9 14a1 1 0 1 0 0-2H4v-2a1 1 0 1 0-2 0v2.5A1.5 1.5 0 0 0 3.5 17zm9 0H15v-2a1 1 0 1 0 2 0v2.5a1.5 1.5 0 0 1-1.5 1.5H13a1 1 0 1 1 0-2" />
                                        </svg>
                                        <span data-commandline-fullscreen-label>全屏模式</span>
                                    </button>
                                </div>
                                <div class="command-shell-terminal h-[60vh] min-h-[420px] p-2">
                                    <CommandLine module={moduleKey} />
                                </div>
                            </div>
                            <p class="mt-2 text-xs text-gray-500">
                                Press Ctrl + C to exit. Output is simulated for demo purposes only.
                            </p>
                        </div>
                        <aside class="space-y-6">
                            <div>
                                <h2 class="text-xs font-semibold uppercase tracking-wide text-gray-400">
                                    Highlights
                                </h2>
                                <ul class="mt-3 list-disc list-inside text-sm text-gray-300 space-y-1">
                                    {guide.highlights.map((item) => (
                                        <li>{item}</li>
                                    ))}
                                </ul>
                            </div>
                            <div>
                                <h2 class="text-xs font-semibold uppercase tracking-wide text-gray-400">
                                    Tags
                                </h2>
                                <div class="mt-3 flex flex-wrap gap-2">
                                    {guide.tags.map((tag) => (
                                        <span class="rounded-full border border-gray-700 px-2 py-1 text-xs text-gray-300">
                                            {tag}
                                        </span>
                                    ))}
                                </div>
                            </div>
                            <div>
                                <h2 class="text-xs font-semibold uppercase tracking-wide text-gray-400">
                                    Quick commands
                                </h2>
                                <div class="mt-3 space-y-2 text-xs text-gray-300">
                                    {commandExamples.map((cmd) => (
                                        <div class="rounded border border-gray-800 bg-gray-950 px-3 py-2 font-mono">
                                            {cmd}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </aside>
                    </div>

                    <div class="mt-10 grid gap-8 lg:grid-cols-2">
                        <div class="space-y-3 text-sm text-gray-300">
                            <h2 class="text-lg font-semibold text-gray-200">Overview</h2>
                            {introParagraphs.map((paragraph) => (
                                <p>{paragraph}</p>
                            ))}
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold text-gray-200">Use cases</h2>
                            <ul class="mt-3 list-disc list-inside text-sm text-gray-300 space-y-1">
                                {guide.scenarios.map((item) => (
                                    <li>{item}</li>
                                ))}
                            </ul>
                            <h3 class="mt-6 text-sm font-semibold text-gray-300">Notes</h3>
                            <ul class="mt-2 list-disc list-inside text-sm text-gray-400 space-y-1">
                                <li>All output is simulated text; no system changes are made.</li>
                                <li>Refresh the page to restart the log stream.</li>
                                <li>Use the CLI for longer sessions or offline demos.</li>
                            </ul>
                        </div>
                    </div>

                    <section class="mt-10">
                        <h2 class="text-lg font-semibold text-gray-200">Sample output</h2>
                        <pre class="mt-3 overflow-auto rounded-md border border-gray-800 bg-gray-950 p-4 text-xs text-gray-300">{guide.sampleOutput.join('\n')}</pre>
                    </section>

                    <section class="mt-10">
                        <h2 class="text-lg font-semibold text-gray-200">FAQ</h2>
                        <div class="mt-4 grid gap-4 lg:grid-cols-2">
                            {faqItems.map((item) => (
                                <div class="rounded-md border border-gray-800 bg-black/50 p-4">
                                    <div class="text-sm font-semibold text-gray-200">{item.question}</div>
                                    <p class="mt-2 text-sm text-gray-400">{item.answer}</p>
                                </div>
                            ))}
                        </div>
                    </section>
                    <section class="mt-10" aria-labelledby="more-about-heading">
                        <h2 id="more-about-heading" class="text-lg font-semibold text-gray-200">
                            What's more about {moduleDisplayName}?
                        </h2>
                        {moreAbout ? (
                            <div class="mt-3 space-y-3 text-sm text-gray-300">
                                {moreAbout.paragraphs.map((p) => (
                                    <p>{p}</p>
                                ))}
                                {moreAbout.learnMoreUrl && (
                                    <p class="pt-2">
                                        <a
                                            href={moreAbout.learnMoreUrl}
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            class="text-gray-200 underline hover:text-white"
                                        >
                                            Learn more at {moreAbout.learnMoreLabel ?? 'official documentation'}
                                        </a>
                                    </p>
                                )}
                            </div>
                        ) : (
                            <p class="mt-2 text-sm text-gray-400">
                                This module simulates log output for demos and testing. All output is generated locally and does not run the real tool.
                            </p>
                        )}
                    </section>

                    {stackOverflowQuestions.length > 0 && (
                        <section class="mt-10" aria-labelledby="stackoverflow-heading">
                            <h2 id="stackoverflow-heading" class="text-lg font-semibold text-gray-200">
                                Stack Overflow Questions
                            </h2>
                            <p class="mt-2 text-sm text-gray-400">
                                Popular questions and answers from Stack Overflow related to {moduleDisplayName}.
                            </p>
                            <div class="mt-4 space-y-4">
                                {stackOverflowQuestions.map((item) => (
                                    <div class="rounded-md border border-gray-800 bg-black/50 p-4">
                                        <div class="flex items-start gap-3">
                                            <svg class="mt-0.5 h-5 w-5 flex-shrink-0 text-orange-500" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M18.986 21.865v-6.404h2.134V24H1.844v-8.539h2.13v6.404h15.012zM6.111 19.731H16.85v-2.137H6.111v2.137zm.259-4.852l10.48 2.189.451-2.07-10.478-2.187-.453 2.068zm1.359-5.056l9.705 4.53.903-1.95-9.706-4.53-.902 1.95zm2.715-4.785l8.217 6.855 1.359-1.62-8.216-6.853-1.36 1.618zM15.751 0l-1.746 1.294 6.405 8.604 1.746-1.294L15.749 0z"/>
                                            </svg>
                                            <div class="flex-1 min-w-0">
                                                <a
                                                    href={item.questionUrl}
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                    class="text-sm font-semibold text-gray-200 hover:text-orange-400 hover:underline"
                                                >
                                                    {item.question}
                                                </a>
                                                <div class="mt-2 rounded bg-gray-900/50 p-3">
                                                    <div class="flex items-center gap-2 text-xs text-green-500 mb-2">
                                                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                                        </svg>
                                                        <span class="font-medium">Accepted Answer</span>
                                                    </div>
                                                    <p class="text-sm text-gray-300 whitespace-pre-line">{item.answer}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </section>
                    )}

                    {youtubeVideos.length > 0 && (
                        <section class="mt-10" aria-labelledby="youtube-heading">
                            <h2 id="youtube-heading" class="text-lg font-semibold text-gray-200 flex items-center gap-2">
                                <svg class="h-6 w-6 text-red-500" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                                </svg>
                                YouTube Tutorials
                            </h2>
                            <p class="mt-2 text-sm text-gray-400">
                                Popular video tutorials to learn more about {moduleDisplayName}.
                            </p>
                            <div class="mt-4 grid gap-6 lg:grid-cols-2">
                                {youtubeVideos.map((video) => (
                                    <div class="rounded-lg border border-gray-800 bg-black/50 overflow-hidden">
                                        <div class="relative aspect-video bg-gray-900">
                                            <iframe
                                                class="absolute inset-0 w-full h-full"
                                                src={`https://www.youtube.com/embed/${video.videoId}`}
                                                title={video.title}
                                                frameborder="0"
                                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                                allowfullscreen
                                                loading="lazy"
                                            ></iframe>
                                        </div>
                                        <div class="p-4">
                                            <a
                                                href={`https://www.youtube.com/watch?v=${video.videoId}`}
                                                target="_blank"
                                                rel="noopener noreferrer"
                                                class="text-sm font-semibold text-gray-200 hover:text-red-400 hover:underline line-clamp-2"
                                            >
                                                {video.title}
                                            </a>
                                            <p class="mt-1 text-xs text-gray-500">
                                                {video.channel}
                                            </p>
                                            <p class="mt-2 text-sm text-gray-400 line-clamp-2">
                                                {video.description}
                                            </p>
                                            <a
                                                href={`https://www.youtube.com/watch?v=${video.videoId}`}
                                                target="_blank"
                                                rel="noopener noreferrer"
                                                class="mt-3 inline-flex items-center gap-1 text-xs text-red-400 hover:text-red-300"
                                            >
                                                <span>Watch on YouTube</span>
                                                <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                                </svg>
                                            </a>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </section>
                    )}

                    <section class="mt-10">
                        <h2 class="text-lg font-semibold text-gray-200">Related modules</h2>
                        <div class="mt-3 grid grid-cols-2 gap-2 sm:grid-cols-3 lg:grid-cols-4">
                            {relatedModules.map((name) => (
                                <a
                                    class="rounded border border-gray-800 bg-gray-950 px-3 py-2 text-xs text-gray-300 hover:border-gray-700 hover:text-white"
                                    href={`/module/${name}`}
                                >
                                    {name}
                                </a>
                            ))}
                        </div>
                    </section>
                </>
            ) : (
                <div class="mt-8 rounded-md border border-red-900/40 bg-red-950/30 p-4 text-sm text-red-200">
                    This module is not available. Please choose a module from the home page.
                </div>
            )}
        </div>
    </div>
    <Footer />
</Layout>

<script is:inline>
    const initCommandLineFullscreen = () => {
        const wrapper = document.getElementById('command-shell-wrapper');
        const toggleButton = document.querySelector('[data-commandline-fullscreen]');
        const toolbar = wrapper?.querySelector('.command-shell-toolbar');
        const topZone = wrapper?.querySelector('[data-commandline-top-zone]');
        if (!wrapper || !toggleButton || !toolbar) {
            return;
        }

        const onPointerReveal = () => {
            if (!isFullscreen) return;
            revealToolbar();
        };

        const label = toggleButton.querySelector('[data-commandline-fullscreen-label]');
        const html = document.documentElement;
        const body = document.body;
        let isFullscreen = false;
        let hideTimer = -1;

        const setToolbarHidden = (hidden) => {
            toolbar.classList.toggle('is-hidden', hidden);
        };

        const clearHideTimer = () => {
            if (hideTimer !== -1) {
                window.clearTimeout(hideTimer);
                hideTimer = -1;
            }
        };

        const scheduleToolbarHide = () => {
            clearHideTimer();
            if (!isFullscreen) {
                return;
            }
            hideTimer = window.setTimeout(() => {
                setToolbarHidden(true);
            }, 2000);
        };

        const revealToolbar = () => {
            setToolbarHidden(false);
            scheduleToolbarHide();
        };

        const applyState = () => {
            wrapper.classList.toggle('is-fullscreen', isFullscreen);
            html.classList.toggle('command-fullscreen-open', isFullscreen);
            body.classList.toggle('command-fullscreen-open', isFullscreen);
            toggleButton.setAttribute('aria-pressed', String(isFullscreen));
            if (label) {
                label.textContent = isFullscreen ? '退出全屏' : '全屏模式';
            }
            if (isFullscreen) {
                revealToolbar();
            } else {
                clearHideTimer();
                setToolbarHidden(false);
            }
            window.dispatchEvent(new Event('resize'));
        };

        const toggleFullscreen = () => {
            isFullscreen = !isFullscreen;
            applyState();
        };

        toggleButton.addEventListener('click', toggleFullscreen);
        toggleButton.addEventListener('focus', onPointerReveal);
        wrapper.addEventListener('pointermove', onPointerReveal);
        if (topZone) {
            topZone.addEventListener('pointerenter', onPointerReveal);
            topZone.addEventListener('pointermove', onPointerReveal);
        }
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && isFullscreen) {
                isFullscreen = false;
                applyState();
            }
        });
    };

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCommandLineFullscreen, { once: true });
    } else {
        initCommandLineFullscreen();
    }
</script>

<style is:global>
    .command-shell-wrapper {
        position: relative;
    }

    .command-shell-toolbar {
        transition: opacity 0.4s ease, transform 0.4s ease;
    }

    .command-shell-toolbar.is-hidden {
        opacity: 0;
        transform: translateY(-100%);
        pointer-events: none;
    }

    .command-shell-top-zone {
        display: none;
    }

    .command-shell-wrapper.is-fullscreen .command-shell-top-zone {
        display: block;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 72px;
        z-index: 10;
        cursor: default;
    }

    .command-shell-wrapper.is-fullscreen {
        position: fixed;
        inset: 0;
        z-index: 40;
        max-width: none;
        width: 100%;
        height: 100vh;
        border-radius: 0;
        border: none;
        padding: 1rem;
        background-color: #050505;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        overflow: visible;
    }

    .command-shell-wrapper.is-fullscreen .command-shell-toolbar {
        position: absolute;
        top: 1rem;
        left: 1rem;
        right: 1rem;
        z-index: 11;
        background: rgba(12, 12, 12, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 0.5rem;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(8px);
    }

    .command-shell-wrapper.is-fullscreen .command-shell-terminal {
        flex: 1;
        height: auto;
        min-height: 0;
    }

    .command-shell-terminal {
        transition: height 0.2s ease;
    }

    html.command-fullscreen-open,
    body.command-fullscreen-open {
        overflow: hidden;
    }
</style>
